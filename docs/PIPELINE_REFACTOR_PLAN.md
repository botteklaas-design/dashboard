# Pipeline Refactor Plan (v1.1 → v2.0)

## Goal
Increase reliability, reduce cost variance, and make dashboard publishing deterministic.

## v1.1 (start now)
1. Add `pipeline-results/latest/run-state.json` as single run-status source.
2. Add `pipeline-results/latest/dashboard-data.json` as structured dashboard payload.
3. Keep markdown artifacts, but treat JSON as primary frontend input.
4. Add publish freshness label:
   - `green`: all core stages succeeded fresh
   - `amber`: fallback/partial used
   - `red`: publish blocked or failed
5. Update dashboard UI to read JSON first, fallback to markdown parsing.

## v1.2 (next)
1. Central model routing policy (local-first + expensive cap).
2. Schema validation on stage handoffs (Scout/Analyst/Dev).
3. Normalized error codes in logs.
4. Automatic recovery path with explicit `amber` status.

## v1.2b (completed)
- [x] Added `scripts/pipeline_auto_recovery.py` for deterministic fallback execution when validation fails.
- [x] Recovery writes/repairs `02-business-analysis.md` and `03-final-winner-summary.md` with `RECOVERY_DRAFT` marker when needed.
- [x] Recovery appends metadata to `latest/00-run-metadata.txt` (`recovery_mode`, `recovery_reason_codes`).
- [x] Recovery appends diagnostics to `latest/pipeline-debug.log` with `AUTO_RECOVERY` prefix.
- [x] Dashboard state now signals amber + fallback freshness and propagates recovery reason codes.
- [x] Cron run-order updated to validate → recover → revalidate → generate dashboard.

## v2.0 (completed)
- [x] State-machine orchestrator with resumable runs.
- [x] Event-driven dashboard (manifest-only reads).
- [x] Ops dashboard (success %, fallback %, runtime trends, blocker heatmap).
- [x] Weekly auto product-bet recommendation with confidence + kill criteria.

## Immediate implementation notes
- Keep `generate_dashboard_state.py` for backward compatibility.
- Primary frontend data now comes from `manifests/*.json` generated by `scripts/generate_manifests.py`.
- Cron flow runs state machine + manifests + weekly decision + dashboard-state before Git push.
