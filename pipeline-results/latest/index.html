<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pipeline Dashboard v2.0</title>
  <style>
    body{font-family:Inter,system-ui,Arial;background:#0b1220;color:#e8eefc;margin:0}
    .wrap{max-width:1150px;margin:0 auto;padding:20px}.card{background:#131d33;border:1px solid #2a3a61;border-radius:12px;padding:14px;margin:10px 0}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}.k{font-size:12px;color:#9fb1d9}.v{font-size:22px;font-weight:700}
    .winner{background:linear-gradient(120deg,#1b3358,#1f3f43)}.pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .green{background:#123a2f;color:#7ef0c8}.amber{background:#3c3114;color:#ffd782}.red{background:#4a1f23;color:#ff9ca8}
    a{color:#9fd0ff}select{background:#0f1729;color:#e8eefc;border:1px solid #2a3a61;border-radius:8px;padding:8px;min-width:280px}
    .bars{display:flex;align-items:flex-end;gap:8px;height:150px;padding:8px;background:#0f1729;border:1px solid #2a3a61;border-radius:10px}.bar{width:34px;background:linear-gradient(180deg,#60a5fa,#34d399);border-radius:6px 6px 0 0;position:relative}.bar span{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);font-size:10px;color:#bcd0f4;white-space:nowrap}
    .winner-list{font-size:13px;color:#c7d8f7;line-height:1.5}.bmc{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.box{background:#0f1729;border:1px solid #2a3a61;border-radius:10px;padding:10px;min-height:95px}
    .lbl{font-size:11px;color:#9fb1d9;text-transform:uppercase}.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#1b2744;border:1px solid #34508a;font-size:11px;color:#cfe0ff}
    .ops-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}.heat td{padding:4px 8px;border-bottom:1px solid #243459;font-size:12px}
    @media(max-width:900px){.grid,.bmc,.ops-grid{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <h1>üìä Dutch Idea Pipeline Dashboard</h1>
  <div id="run" class="k">Laden‚Ä¶</div>

  <div class="card winner" id="winner">Winner laden‚Ä¶</div>

  <div class="grid">
    <div class="card"><div class="k">Status</div><div id="status">-</div></div>
    <div class="card"><div class="k">Idee√´n</div><div class="v" id="ideas">-</div></div>
    <div class="card"><div class="k">Winner score</div><div class="v" id="score">-</div></div>
    <div class="card"><div class="k">Confidence bet</div><div class="v" id="betConfidence">-</div></div>
  </div>

  <div class="card">
    <h3 style="margin:0">Quality Signal</h3>
    <div class="k" id="freshness">Freshness: -</div>
    <div class="k" id="validationPass">Validation: -</div>
    <div class="k" id="scoutSource">Scout source: -</div>
    <div class="badges" id="errorCodes"><span class="k">Geen error codes</span></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Trendkaart (laatste runs)</h3>
    <div class="bars" id="trendBars"><div class="k">Laden‚Ä¶</div></div>
    <div class="winner-list" id="winnerTrend" style="margin-top:10px">Laden‚Ä¶</div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Ops Dashboard</h3>
    <div class="ops-grid">
      <div class="box"><div class="lbl">Success rate</div><div class="v" id="successRate">-</div><div class="k" id="successRateMeta"></div></div>
      <div class="box"><div class="lbl">Fallback rate</div><div class="v" id="fallbackRate">-</div><div class="k">Last 30 runs</div></div>
      <div class="box"><div class="lbl">Runtime trend (sec)</div><div class="bars" id="runtimeBars" style="height:120px"></div></div>
      <div class="box"><div class="lbl">Blocker heatmap</div><table class="heat" id="heatmap"></table></div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">Business Model Canvas per idee</h3>
      <select id="ideaSelect"></select>
    </div>
    <div class="k" id="ideaMeta" style="margin-top:8px">Laden‚Ä¶</div>
    <div class="bmc" style="margin-top:10px">
      <div class="box"><div class="lbl">Probleem</div><div id="bmcProblem">-</div></div>
      <div class="box"><div class="lbl">Doelgroep (ICP)</div><div id="bmcIcp">-</div></div>
      <div class="box"><div class="lbl">Waardepropositie</div><div id="bmcValue">-</div></div>
      <div class="box"><div class="lbl">Revenue</div><div id="bmcRevenue">-</div></div>
      <div class="box"><div class="lbl">MVP Scope</div><div id="bmcMvp">-</div></div>
      <div class="box"><div class="lbl">Belangrijkste Risico</div><div id="bmcRisk">-</div></div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Artifacts</h3>
    <ul>
      <li><a href="manifests/run-manifest.json">manifests/run-manifest.json</a></li>
      <li><a href="manifests/ideas-manifest.json">manifests/ideas-manifest.json</a></li>
      <li><a href="manifests/trend-manifest.json">manifests/trend-manifest.json</a></li>
      <li><a href="manifests/ops-manifest.json">manifests/ops-manifest.json</a></li>
      <li><a href="state-machine.json">state-machine.json</a></li>
      <li><a href="run-events.jsonl">run-events.jsonl</a></li>
      <li><a href="weekly-decision.json">weekly-decision.json</a></li>
    </ul>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
async function getJson(p){ const r=await fetch(p,{cache:'no-store'}); if(!r.ok) return null; return r.json(); }
function statusPill(s){const c=s==='green'?'green':(s==='amber'?'amber':'red');return `<span class="pill ${c}">${(s||'unknown').toUpperCase()}</span>`;}
function statusColorFromRun(st){ if(st==='COMPLETE'||st==='green') return 'green'; if(st==='FAILED'||st==='red') return 'red'; return 'amber'; }

(async()=>{
  const [run,ideas,tr,ops,weekly]=await Promise.all([
    getJson('manifests/run-manifest.json'),
    getJson('manifests/ideas-manifest.json'),
    getJson('manifests/trend-manifest.json'),
    getJson('manifests/ops-manifest.json'),
    getJson('weekly-decision.json'),
  ]);
  if(!run){ $('winner').textContent='Geen manifests gevonden'; return; }

  $('run').textContent='Laatste run: '+(run.runId||'-')+' ‚Ä¢ '+(run.generatedAt||'');
  $('winner').innerHTML=`üèÜ <b>${run.winner||'Onbekend'}</b><br><span class="k">Score: ${run.winnerScore||'-'}</span>`;
  $('status').innerHTML=statusPill(statusColorFromRun(run.status));
  $('ideas').textContent=run.ideasCount ?? (ideas&&ideas.count) ?? '-';
  $('score').textContent=run.winnerScore || '-';
  $('betConfidence').textContent=(weekly&&weekly.singleProductBet&&weekly.singleProductBet.confidence!=null)?weekly.singleProductBet.confidence:'-';

  const quality=run.quality||{}; const fresh=quality.freshness||{};
  $('freshness').textContent=`Freshness: ${fresh.label||quality.freshness||'unknown'}${fresh.minutes==null?'':` (${fresh.minutes} min)`}`;
  $('validationPass').textContent=`Validation: ${quality.validationPass===true?'PASS':(quality.validationPass===false?'FAIL':'UNKNOWN')}`;
  $('scoutSource').textContent=`Scout source: ${(run.scoutSource||quality.scoutSource||'history_fallback')}`;
  const codes=(run.errorCodes||[]).slice(0,10);
  $('errorCodes').innerHTML=codes.length?codes.map(c=>`<span class="badge">${c}</span>`).join(''):'<span class="k">Geen error codes</span>';

  const trend=(tr&&tr.points)||[];
  if(!trend.length){ $('trendBars').innerHTML='<div class="k">Nog geen trenddata</div>'; $('winnerTrend').textContent='-'; }
  else {
    const points=trend.slice(-8).map(t=>{const m=(t.score||'').match(/(\d+)\/(\d+)/)||[]; const n=m[1]?parseInt(m[1],10):0; const d=m[2]?parseInt(m[2],10):35; const pct=d?Math.round((n/d)*100):12; return {t:t.timestamp,w:t.winner,n,d,pct};});
    $('trendBars').innerHTML=points.map(p=>`<div class="bar" style="height:${Math.max(8,p.pct)}px"><span>${p.n}/${p.d}<br>${(p.t||'').slice(5)}</span></div>`).join('');
    $('winnerTrend').innerHTML=points.map(p=>`‚Ä¢ ${p.t}: <b>${p.w||'-'}</b>`).join('<br>');
  }

  if(ops){
    $('successRate').textContent=`${ops.successRate?.last7 ?? '-'}%`;
    $('successRateMeta').textContent=`7-run / 30-run: ${ops.successRate?.last7 ?? '-'}% / ${ops.successRate?.last30 ?? '-'}%`;
    $('fallbackRate').textContent=`${ops.fallbackRate?.last30 ?? '-'}%`;
    const rt=(ops.runtimeTrend||[]).filter(x=>x.runtime_sec!=null);
    if(!rt.length) $('runtimeBars').innerHTML='<div class="k">geen runtime data</div>';
    else {
      const max=Math.max(...rt.map(x=>x.runtime_sec),1);
      $('runtimeBars').innerHTML=rt.slice(-12).map((p,i)=>`<div class="bar" style="height:${Math.max(6,Math.round((p.runtime_sec/max)*100))}px"><span>#${i+1}<br>${p.runtime_sec}s</span></div>`).join('');
    }
    const hm=ops.blockerHeatmap||[];
    $('heatmap').innerHTML=hm.length?hm.map(r=>`<tr><td>${r.errorCode}</td><td>${r.count}</td></tr>`).join(''):'<tr><td colspan="2" class="k">no blockers</td></tr>';
  }

  const list=(ideas&&ideas.ideas)||[]; const sel=$('ideaSelect');
  if(!list.length){sel.innerHTML='<option>Geen idee-data gevonden</option>'; $('ideaMeta').textContent='-'; return;}
  sel.innerHTML=list.map((i,idx)=>`<option value="${idx}">${i.id}. ${i.title}</option>`).join('');
  function renderIdea(idx){const it=list[idx]||list[0]; $('ideaMeta').textContent=`Score: ${it.score} ‚Ä¢ Repetition: ${it.repetition} ‚Ä¢ Confidence: ${it.confidence}`; $('bmcProblem').textContent=it.bmc.problem; $('bmcIcp').textContent=it.bmc.icp; $('bmcValue').textContent=it.bmc.value; $('bmcRevenue').textContent=it.bmc.revenue; $('bmcMvp').textContent=it.bmc.mvp; $('bmcRisk').textContent=it.bmc.risk;}
  renderIdea(0); sel.addEventListener('change',e=>renderIdea(parseInt(e.target.value,10)||0));
})();
</script>
</body></html>
